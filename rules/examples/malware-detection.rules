# Malware Detection Rules
# These rules detect malware-related network activity
# Author: Suricata Documentation Project
# Last Updated: 2024

# ===================================
# Command and Control (C2) Detection
# ===================================

# Generic C2 - Suspicious User-Agent with POST
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible C2 - Suspicious User-Agent with POST"; flow:established,to_server; http.method; content:"POST"; http.user_agent; pcre:"/^[A-Za-z]{4,8}$/"; classtype:trojan-activity; sid:1000200; rev:1; priority:1;)

# C2 - Beacon Pattern (Regular Intervals)
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible C2 Beacon - Regular HTTP Requests"; flow:established,to_server; threshold:type both, track by_src, count 10, seconds 60; classtype:trojan-activity; sid:1000201; rev:1; priority:2;)

# C2 - Base64 Encoded Data in POST
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible C2 - Base64 Encoded POST Data"; flow:established,to_server; http.method; content:"POST"; http.request_body; pcre:"/^[A-Za-z0-9+\/]{100,}={0,2}$/m"; classtype:trojan-activity; sid:1000202; rev:1; priority:2;)

# C2 - Non-Standard HTTP Port
alert http $HOME_NET any -> $EXTERNAL_NET !$HTTP_PORTS (msg:"Possible C2 - HTTP on Non-Standard Port"; flow:established,to_server; classtype:trojan-activity; sid:1000203; rev:1; priority:2;)

# C2 - Empty Accept Header
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible C2 - Empty Accept Header"; flow:established,to_server; http.accept; content:""; classtype:trojan-activity; sid:1000204; rev:1; priority:3;)

# C2 - POST to Root Path
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible C2 - POST to Root Path"; flow:established,to_server; http.method; content:"POST"; http.uri; content:"/"; depth:1; pcre:"/^\/$/"; classtype:trojan-activity; sid:1000205; rev:1; priority:2;)

# C2 - Cookie-based C2 Communication
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible C2 - Long Cookie Value"; flow:established,to_server; http.cookie; pcre:"/^.{200,}/"; classtype:trojan-activity; sid:1000206; rev:1; priority:2;)

# ===================================
# Domain Generation Algorithm (DGA)
# ===================================

# DGA - Long Random Subdomain
alert dns $HOME_NET any -> any 53 (msg:"Possible DGA - Long Random Subdomain"; dns.query; pcre:"/^[a-z0-9]{20,}\./i"; classtype:trojan-activity; sid:1000210; rev:1; priority:2;)

# DGA - High Entropy Domain Name
alert dns $HOME_NET any -> any 53 (msg:"Possible DGA - High Entropy Domain"; dns.query; pcre:"/^[bcdfghjklmnpqrstvwxyz]{8,}\./i"; classtype:trojan-activity; sid:1000211; rev:1; priority:2;)

# DGA - Multiple Failed DNS Queries
alert dns $HOME_NET any -> any 53 (msg:"Possible DGA - Multiple Failed Queries"; dns.rcode; content:"NXDOMAIN"; threshold:type threshold, track by_src, count 10, seconds 60; classtype:trojan-activity; sid:1000212; rev:1; priority:1;)

# DGA - Suspicious TLD (.tk, .ml, .ga, .cf)
alert dns $HOME_NET any -> any 53 (msg:"Suspicious Domain - Free TLD"; dns.query; pcre:"/\.(tk|ml|ga|cf|gq)$/i"; classtype:potentially-bad-traffic; sid:1000213; rev:1; priority:3;)

# DGA - Numeric Subdomain Pattern
alert dns $HOME_NET any -> any 53 (msg:"Possible DGA - Numeric Subdomain"; dns.query; pcre:"/^\d+\./"; classtype:trojan-activity; sid:1000214; rev:1; priority:3;)

# ===================================
# Cryptocurrency Mining Detection
# ===================================

# Crypto Mining - Stratum Protocol
alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"Cryptocurrency Mining - Stratum Protocol"; flow:established,to_server; content:"mining.subscribe"; nocase; classtype:trojan-activity; reference:url,en.bitcoin.it/wiki/Stratum_mining_protocol; sid:1000220; rev:1; priority:1;)

# Crypto Mining - Pool Connection
alert tcp $HOME_NET any -> $EXTERNAL_NET [3333,4444,5555,7777,8888,9999] (msg:"Cryptocurrency Mining - Pool Port Connection"; flow:established,to_server; flags:S; classtype:trojan-activity; sid:1000221; rev:1; priority:2;)

# Crypto Mining - XMRig User-Agent
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Cryptocurrency Mining - XMRig User-Agent"; flow:established,to_server; http.user_agent; content:"XMRig"; nocase; classtype:trojan-activity; sid:1000222; rev:1; priority:1;)

# Crypto Mining - Coinhive Domain
alert http any any -> any any (msg:"Cryptocurrency Mining - CoinHive Script"; flow:established; http.host; content:"coinhive.com"; nocase; classtype:trojan-activity; sid:1000223; rev:1; priority:1;)

# Crypto Mining - CryptoNight Hash
alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"Cryptocurrency Mining - CryptoNight Algorithm"; flow:established; content:"cryptonight"; nocase; classtype:trojan-activity; sid:1000224; rev:1; priority:2;)

# Crypto Mining - Monero Pool
alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"Cryptocurrency Mining - Monero Pool Connection"; flow:established,to_server; content:"xmr"; nocase; content:"pool"; nocase; distance:0; classtype:trojan-activity; sid:1000225; rev:1; priority:2;)

# ===================================
# Ransomware Indicators
# ===================================

# Ransomware - Tor Network Access
alert tcp $HOME_NET any -> $EXTERNAL_NET [9001,9030,9050,9051,9150] (msg:"Possible Ransomware - Tor Network Connection"; flow:to_server,established; classtype:trojan-activity; reference:url,www.torproject.org; sid:1000230; rev:1; priority:1;)

# Ransomware - Bitcoin Payment Portal
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible Ransomware - Bitcoin Payment Reference"; flow:established; content:"bitcoin"; nocase; content:"payment"; nocase; distance:0; classtype:trojan-activity; sid:1000231; rev:1; priority:2;)

# Ransomware - SMB Exploit Activity (EternalBlue)
alert tcp $HOME_NET any -> $HOME_NET 445 (msg:"Possible Ransomware - SMB Exploit Activity"; flow:to_server,established; content:"|ff|SMB"; depth:5; content:"|00 00 00 00|"; distance:5; classtype:attempted-admin; reference:cve,2017-0144; sid:1000232; rev:1; priority:1;)

# Ransomware - File Extension in DNS Query (.encrypted, .locked)
alert dns $HOME_NET any -> any 53 (msg:"Possible Ransomware - Encrypted File Extension in DNS"; dns.query; pcre:"/\.(encrypted|locked|crypto|cerber|locky|zepto)/i"; classtype:trojan-activity; sid:1000233; rev:1; priority:2;)

# Ransomware - Volume Shadow Copy Deletion
alert tcp $HOME_NET any -> $HOME_NET any (msg:"Possible Ransomware - Shadow Copy Deletion Command"; flow:established; content:"vssadmin"; nocase; content:"delete"; nocase; distance:0; content:"shadows"; nocase; distance:0; classtype:trojan-activity; sid:1000234; rev:1; priority:1;)

# ===================================
# Suspicious File Downloads
# ===================================

# Suspicious Download - Executable from Web
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious Download - Windows Executable"; flow:established,from_server; file_data; content:"MZ"; depth:2; content:"This program"; distance:0; classtype:trojan-activity; sid:1000240; rev:1; priority:2;)

# Suspicious Download - PowerShell Script
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious Download - PowerShell Script"; flow:established,from_server; http.content_type; content:"text/plain"; http.server_body; content:"powershell"; nocase; classtype:trojan-activity; sid:1000241; rev:1; priority:2;)

# Suspicious Download - Batch Script
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious Download - Batch Script"; flow:established,from_server; http.content_type; content:"text/plain"; file_data; content:"@echo off"; nocase; depth:20; classtype:trojan-activity; sid:1000242; rev:1; priority:2;)

# Suspicious Download - VBScript
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious Download - VBScript File"; flow:established,from_server; file_data; content:"Wscript"; nocase; depth:100; content:"CreateObject"; nocase; distance:0; classtype:trojan-activity; sid:1000243; rev:1; priority:2;)

# Suspicious Download - Macro-Enabled Office Document
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious Download - Macro-Enabled Document"; flow:established,from_server; http.content_type; content:"application/vnd.ms-excel.sheet.macroEnabled"; classtype:trojan-activity; sid:1000244; rev:1; priority:2;)

# Suspicious Download - HTA File
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious Download - HTA Application"; flow:established,from_server; http.content_type; content:"application/hta"; classtype:trojan-activity; sid:1000245; rev:1; priority:1;)

# Suspicious Download - DLL File
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious Download - DLL File"; flow:established,from_server; file_data; content:"MZ"; depth:2; content:".dll"; nocase; distance:0; classtype:trojan-activity; sid:1000246; rev:1; priority:2;)

# ===================================
# Backdoor and RAT Detection
# ===================================

# RAT - Netcat Usage
alert tcp any any -> $HOME_NET any (msg:"Possible RAT - Netcat Connection"; flow:established; content:"cmd.exe"; nocase; content:"/c"; nocase; distance:0; classtype:trojan-activity; sid:1000250; rev:1; priority:1;)

# RAT - Reverse Shell Pattern
alert tcp $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible RAT - Reverse Shell Connection"; flow:established,to_server; content:"/bin/bash"; nocase; classtype:trojan-activity; sid:1000251; rev:1; priority:1;)

# RAT - Meterpreter Session
alert tcp any any -> any any (msg:"Possible RAT - Meterpreter Pattern"; flow:established; content:"meterpreter"; nocase; classtype:trojan-activity; sid:1000252; rev:1; priority:1;)

# RAT - Empire Framework
alert http any any -> any any (msg:"Possible RAT - PowerShell Empire"; flow:established; http.user_agent; content:"Mozilla/5.0 (Windows NT 6.1"; content:"GUID="; http.uri; classtype:trojan-activity; sid:1000253; rev:1; priority:1;)

# RAT - Cobalt Strike Beacon
alert tcp any any -> any any (msg:"Possible RAT - Cobalt Strike Beacon"; flow:established; content:"Microsoft-CryptoAPI"; http.user_agent; classtype:trojan-activity; sid:1000254; rev:1; priority:1;)

# ===================================
# Malware Communication Patterns
# ===================================

# Malware - DNS Query to Pastebin
alert dns $HOME_NET any -> any 53 (msg:"Suspicious - DNS Query to Pastebin"; dns.query; content:"pastebin.com"; nocase; classtype:trojan-activity; sid:1000260; rev:1; priority:2;)

# Malware - Connection to Onion Domain
alert dns $HOME_NET any -> any 53 (msg:"Suspicious - Onion Domain Query"; dns.query; content:".onion"; nocase; classtype:trojan-activity; sid:1000261; rev:1; priority:2;)

# Malware - HTTP POST with Long URI
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Suspicious - HTTP POST with Long URI"; flow:established,to_server; http.method; content:"POST"; http.uri; pcre:"/^.{200,}/"; classtype:trojan-activity; sid:1000262; rev:1; priority:3;)

# Malware - Binary Data in HTTP POST
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Suspicious - Binary Data in POST Body"; flow:established,to_server; http.method; content:"POST"; http.request_body; content:"|00 00|"; classtype:trojan-activity; sid:1000263; rev:1; priority:3;)

# Malware - No Referer with POST
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Suspicious - POST without Referer"; flow:established,to_server; http.method; content:"POST"; http.referer; content:""; classtype:trojan-activity; sid:1000264; rev:1; priority:3;)

# ===================================
# Exploit Kit Detection
# ===================================

# Exploit Kit - Suspicious JavaScript Obfuscation
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Exploit Kit - Heavily Obfuscated JavaScript"; flow:established,from_server; file_data; content:"eval"; nocase; content:"unescape"; nocase; distance:0; classtype:trojan-activity; sid:1000270; rev:1; priority:2;)

# Exploit Kit - Flash Exploit
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Exploit Kit - Suspicious Flash Content"; flow:established,from_server; http.content_type; content:"application/x-shockwave-flash"; file_data; content:"ExternalInterface"; nocase; classtype:trojan-activity; sid:1000271; rev:1; priority:2;)

# Exploit Kit - CVE Pattern in URI
alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Exploit Kit - CVE Reference in URI"; flow:established; http.uri; pcre:"/cve-\d{4}-\d{4,}/i"; classtype:trojan-activity; sid:1000272; rev:1; priority:2;)

# ===================================
# Botnet Detection
# ===================================

# Botnet - IRC Command Channel
alert tcp $HOME_NET any -> $EXTERNAL_NET [6667,6668,6669,7000] (msg:"Possible Botnet - IRC Connection"; flow:established,to_server; content:"NICK"; depth:4; classtype:trojan-activity; sid:1000280; rev:1; priority:2;)

# Botnet - Rapid DNS Queries
alert dns $HOME_NET any -> any 53 (msg:"Possible Botnet - Excessive DNS Queries"; threshold:type threshold, track by_src, count 50, seconds 10; classtype:trojan-activity; sid:1000281; rev:1; priority:1;)

# Botnet - P2P Communication Pattern
alert udp $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible Botnet - P2P Communication"; content:"BitTorrent"; depth:20; classtype:policy-violation; sid:1000282; rev:1; priority:3;)

# ===================================
# Malicious TLS/SSL Activity
# ===================================

# Malicious TLS - Self-Signed Certificate
alert tls $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious TLS - Self-Signed Certificate"; tls.cert_issuer; content:"Self"; nocase; classtype:bad-unknown; sid:1000290; rev:1; priority:3;)

# Malicious TLS - Unusual Certificate CN
alert tls $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious TLS - Random CN Pattern"; tls.subject; pcre:"/CN=[a-z0-9]{20,}/i"; classtype:trojan-activity; sid:1000291; rev:1; priority:2;)

# Malicious TLS - Certificate for IP Address
alert tls $EXTERNAL_NET any -> $HOME_NET any (msg:"Suspicious TLS - Certificate for IP Address"; tls.sni; pcre:"/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/"; classtype:bad-unknown; sid:1000292; rev:1; priority:2;)

# ===================================
# Data Exfiltration
# ===================================

# Exfiltration - Large Upload
alert http $HOME_NET any -> $EXTERNAL_NET any (msg:"Possible Data Exfiltration - Large POST"; flow:established,to_server; http.method; content:"POST"; dsize:>100000; classtype:trojan-activity; sid:1000300; rev:1; priority:2;)

# Exfiltration - DNS Tunneling (Long TXT Query)
alert dns $HOME_NET any -> any 53 (msg:"Possible Data Exfiltration - DNS Tunneling"; dns.query; isdataat:100,relative; classtype:trojan-activity; sid:1000301; rev:1; priority:1;)

# Exfiltration - FTP Upload
alert ftp $HOME_NET any -> $EXTERNAL_NET 21 (msg:"Possible Data Exfiltration - FTP Upload"; flow:established,to_server; content:"STOR"; depth:4; classtype:trojan-activity; sid:1000302; rev:1; priority:3;)

# Exfiltration - HTTPS to Cloud Storage
alert tls $HOME_NET any -> $EXTERNAL_NET 443 (msg:"Possible Data Exfiltration - Cloud Storage Upload"; tls.sni; content:"dropbox.com"; nocase; dsize:>50000; classtype:policy-violation; sid:1000303; rev:1; priority:3;)

# ===================================
# Notes:
# - These rules detect indicators of malware and malicious activity
# - Many patterns may also match legitimate traffic - tune carefully
# - Consider your environment when enabling these rules
# - Use in combination with threat intelligence feeds for better accuracy
# - Regular updates and tuning are essential for effectiveness
# - False positives are common - investigate alerts carefully
# ===================================
